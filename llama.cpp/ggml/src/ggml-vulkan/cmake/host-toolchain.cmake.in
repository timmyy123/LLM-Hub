# Propagate toolchain variables into try_compile/test project (CMake 3.19+)
set(CMAKE_TRY_COMPILE_PLATFORM_VARIABLES
    CMAKE_C_COMPILER
    CMAKE_CXX_COMPILER
    CMAKE_LINKER
    CMAKE_C_LINK_EXECUTABLE
    CMAKE_CXX_LINK_EXECUTABLE
    CMAKE_RC_COMPILER
    CMAKE_RC_EXECUTABLE
    CMAKE_MT
    MSVC_TOOL_DIR
    CACHE STRING "" FORCE)

set(CMAKE_BUILD_TYPE Release)
set(CMAKE_C_FLAGS -O2)
set(CMAKE_CXX_FLAGS -O2)
set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)
set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY NEVER)
set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE NEVER)
set(CMAKE_C_COMPILER "@HOST_C_COMPILER@")
set(CMAKE_CXX_COMPILER "@HOST_CXX_COMPILER@")
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY @CMAKE_RUNTIME_OUTPUT_DIRECTORY@)

# Set MSVC toolchain paths (substituted by configure_file)
set(CMAKE_LINKER "@MSVC_TOOL_DIR@/link.exe" CACHE FILEPATH "MSVC linker" FORCE)
set(CMAKE_RC_COMPILER "@MSVC_TOOL_DIR@/rc.exe" CACHE FILEPATH "MSVC resource compiler" FORCE)
set(CMAKE_MT "@MSVC_TOOL_DIR@/mt.exe" CACHE FILEPATH "MSVC manifest tool" FORCE)
set(ENV{RC} "@MSVC_TOOL_DIR@/rc.exe")

# Force CMake to use MSVC tools for all linking/resource steps
set(CMAKE_C_LINKER "@MSVC_TOOL_DIR@/link.exe" CACHE FILEPATH "MSVC linker" FORCE)
set(CMAKE_CXX_LINKER "@MSVC_TOOL_DIR@/link.exe" CACHE FILEPATH "MSVC linker" FORCE)
set(CMAKE_RC_EXECUTABLE "@MSVC_TOOL_DIR@/rc.exe" CACHE FILEPATH "MSVC resource compiler" FORCE)

# Override link command templates to use MSVC linker directly
set(CMAKE_C_LINK_EXECUTABLE "\"@MSVC_TOOL_DIR@/link.exe\" /nologo <OBJECTS> /out:<TARGET> <LINK_FLAGS> <LINK_LIBRARIES>" CACHE STRING "C link command" FORCE)
set(CMAKE_CXX_LINK_EXECUTABLE "\"@MSVC_TOOL_DIR@/link.exe\" /nologo <OBJECTS> /out:<TARGET> <LINK_FLAGS> <LINK_LIBRARIES>" CACHE STRING "CXX link command" FORCE)

if("@CMAKE_C_COMPILER_ID@" STREQUAL "MSVC")
    foreach(CONFIG IN ITEMS DEBUG RELEASE MINSIZEREL RELWITHDEBINFO)
        set(CMAKE_RUNTIME_OUTPUT_DIRECTORY_${CONFIG} ${CMAKE_RUNTIME_OUTPUT_DIRECTORY})
    endforeach()
endif()
